<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | WSL Interior Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .sidebar {
            width: 250px;
            background-color: var(--primary-color);
            color: white;
            padding: 2rem;
            flex-shrink: 0;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .mobile-toggle {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
            margin-right: 1rem;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .mobile-toggle {
                display: block;
            }

            .main-content {
                padding: 1rem;
                width: 100%;
            }

            /* Responsive Tables (Card View) */
            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                margin-bottom: 1rem;
                border: 1px solid #ddd;
                border-radius: 8px;
                background: white;
                padding: 0.5rem;
            }

            td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: right;
                padding: 0.5rem;
                border-bottom: 1px solid #eee;
            }

            td:last-child {
                border-bottom: none;
            }

            td:before {
                position: absolute;
                top: 0.5rem;
                left: 0.5rem;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                content: attr(data-label);
            }
        }

        .sidebar h2 {
            margin-bottom: 2rem;
            font-family: 'Playfair Display', serif;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar li {
            margin-bottom: 1rem;
        }

        .sidebar a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            display: block;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .sidebar a:hover,
        .sidebar a.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .main-content {
            flex-grow: 1;
            padding: 2rem;
            background-color: #f4f4f4;
            overflow-y: auto;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f9f9f9;
            font-weight: 600;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: #ffeeba;
            color: #856404;
        }

        .status-completed {
            background-color: #d4edda;
            color: #155724;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked+.toggle-slider:before {
            transform: translateX(26px);
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h2>WSL Admin</h2>
            <ul>
                <li><a href="#" class="active" onclick="switchTab('products')"><i class="fas fa-couch"></i> Products</a>
                </li>
                <li><a href="#" onclick="switchTab('transactions')"><i class="fas fa-file-invoice-dollar"></i>
                        Transactions</a></li>
                <li><a href="#" onclick="switchTab('clients')"><i class="fas fa-users"></i> Clients</a></li>
                <li><a href="#" onclick="switchTab('inbox')"><i class="fas fa-inbox"></i> Inbox <span id="inbox-badge"
                            class="badge" style="display:none;">0</span></a></li>
                <li><a href="#" onclick="switchTab('contact')"><i class="fas fa-address-card"></i> Contact Info</a></li>
                <li><a href="#" onclick="switchTab('settings')"><i class="fas fa-cog"></i> Bot Settings</a></li>
                <li style="margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                    <a href="index.html"><i class="fas fa-home"></i> Back to Home</a>
                </li>
                <li><a href="#" onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i>
                        Logout</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="admin-header">
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-bars mobile-toggle"
                        onclick="document.querySelector('.sidebar').classList.toggle('active')"></i>
                    <h1 id="page-title" style="margin: 0;">Product Management</h1>
                </div>
                <div class="user-info">
                    <span>Welcome, <strong id="admin-email">Admin</strong></span>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products-tab" class="tab-content active">
                <div class="card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>All Products</h3>
                        <button class="btn btn-sm" onclick="openAddProductModal()">+ Add New Product</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="products-table">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <th>Category</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Products injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Product Modal -->
            <div id="product-modal" class="modal"
                style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
                <div class="modal-content"
                    style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 500px; border-radius: 8px;">
                    <span class="close" onclick="document.getElementById('product-modal').style.display='none'"
                        style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                    <h2 id="modal-title" style="margin-bottom: 1.5rem;">Add Product</h2>
                    <form id="product-form">
                        <input type="hidden" id="prod-id">
                        <div class="form-group">
                            <label>Product Name</label>
                            <input type="text" id="prod-name" required>
                        </div>
                        <div class="form-group">
                            <label>Price (₦)</label>
                            <input type="number" id="prod-price" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select id="prod-category">
                                <option value="Living Room">Living Room</option>
                                <option value="Dining">Dining</option>
                                <option value="Bedroom">Bedroom</option>
                                <option value="Office">Office</option>
                                <option value="Decor">Decor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Image URL</label>
                            <input type="text" id="prod-image" placeholder="images/..." required>
                        </div>
                        <button type="submit" class="btn" style="width: 100%;">Save Product</button>
                    </form>
                </div>
            </div>
    </div>

    <!-- Transactions Tab -->
    <div id="transactions-tab" class="tab-content">
        <div class="card">
            <h3>Record New Transaction</h3>
            <form onsubmit="handleTransactionSubmit(event)">
                <div class="form-group">
                    <label>Client Name</label>
                    <input type="text" id="client-name" required>
                </div>
                <div class="form-group">
                    <label>Contact/Email</label>
                    <input type="text" id="client-contact" required>
                </div>
                <div class="form-group">
                    <label>Property Bought</label>
                    <input type="text" id="property-bought" required>
                </div>
                <div class="form-group">
                    <label>Transaction Receipt</label>
                    <input type="file" id="receipt-upload">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="transaction-status">
                        <option value="Pending">Pending</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <button type="submit" class="btn">Record Transaction</button>
            </form>
        </div>

        <div class="card">
            <h3>Recent Transactions</h3>
            <table id="transactions-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Items</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Transactions injected here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Clients Tab -->
    <div id="clients-tab" class="tab-content">
        <div class="card">
            <h3>Registered Clients</h3>
            <table id="clients-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Cart Items</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Clients injected here -->
                </tbody>
            </table>
        </div>

        <div class="card">
            <h3>Send Notification</h3>
            <form onsubmit="handleSendNotification(event)">
                <div class="form-group">
                    <label>Select Client</label>
                    <select id="notif-client-select" required>
                        <option value="">-- Select Client --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Message</label>
                    <textarea id="notif-message" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn">Send Notification</button>
            </form>
        </div>
    </div>

    <!-- Inbox Tab -->
    <div id="inbox-tab" class="tab-content">
        <div class="card">
            <h3>Bot Messages</h3>
            <div id="inbox-messages">
                <!-- Messages injected here -->
            </div>
        </div>
    </div>

    <!-- Contact Info Tab -->
    <div id="contact-tab" class="tab-content">
        <div class="card">
            <h3>Update Contact Information</h3>
            <form onsubmit="handleContactUpdate(event)">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="contact-email" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="text" id="contact-phone" required>
                </div>
                <div class="form-group">
                    <label>WhatsApp Number</label>
                    <input type="text" id="contact-whatsapp" required>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="contact-address" required>
                </div>
                <button type="submit" class="btn">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
        <div class="card">
            <h3>Bot Settings</h3>
            <p style="color: #666; margin-bottom: 1.5rem;">Control how the WSL Bot handles customer interactions
                and data recording.</p>

            <div class="form-group"
                style="border: 1px solid #eee; padding: 1.5rem; border-radius: 8px; background: #f9f9f9;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <label style="font-size: 1.1rem; margin-bottom: 0.5rem; display: block;">Enable Bot Data
                            Recording</label>
                        <p style="color: #666; font-size: 0.9rem; margin: 0;">When enabled, the bot will save
                            all customer messages, negotiation requests, problem reports, and payment
                            confirmations to your admin inbox. When disabled, the bot will still respond to
                            customers but won't record data.</p>
                    </div>
                    <label class="toggle-switch" style="margin-left: 2rem;">
                        <input type="checkbox" id="bot-recording-toggle" onchange="handleBotRecordingToggle()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div id="recording-status" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; font-weight: 500;">
                <!-- Status will be updated by JavaScript -->
            </div>
        </div>
    </div>
    </main>
    </div>

    <!-- Edit Product Modal -->
    <div id="edit-product-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
            <h2>Edit Product</h2>
            <form onsubmit="handleProductUpdate(event)">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="edit-name" required>
                </div>
                <div class="form-group">
                    <label>Price (₦)</label>
                    <input type="number" id="edit-price" required>
                </div>
                <div class="form-group">
                    <label>Image URL</label>
                    <input type="text" id="edit-image" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Update Product</button>
            </form>
        </div>
    </div>

    <!-- View Cart Modal -->
    <div id="view-cart-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal"
                onclick="document.getElementById('view-cart-modal').style.display='none'">&times;</span>
            <h2>Client Cart</h2>
            <div id="client-cart-content"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    <script src="script.js"></script>
    <script src="bot.js"></script>
    <script>
        // Check Auth
        document.addEventListener('DOMContentLoaded', () => {
            if (!state.currentUser || !state.currentUser.isAdmin) {
                alert("Access Denied. Admins only.");
                window.location.href = 'login.html';
                return;
            }

            document.getElementById('admin-email').textContent = state.currentUser.email;

            renderProductsTable();
            renderTransactionsTable();
            renderClientsTable();
            renderInbox();
            loadContactInfo();
            loadBotSettings();
        });

        // Tab Switching
        function switchTab(tabName) {
            // Update Sidebar
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            event.target.closest('a').classList.add('active');

            // Update Content
            document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Update Title
            const titles = {
                'products': 'Product Management',
                'transactions': 'Transaction Records',
                'clients': 'Client Management',
                'inbox': 'Bot Inbox',
                'contact': 'Contact Information',
                'settings': 'Bot Settings'
            };
            document.getElementById('page-title').textContent = titles[tabName];
        }

        // Products Logic
        function renderProductsTable() {
            const tbody = document.querySelector('#products-table tbody');
            tbody.innerHTML = '';

            state.products.forEach(product => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Image"><img src="${product.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;"></td>
                    <td data-label="Name">${product.name}</td>
                    <td data-label="Price">${formatPrice(product.price)}</td>
                    <td data-label="Category">${product.category}</td>
                    <td data-label="Actions">
                        <button class="btn-sm btn" onclick="openEditModal(${product.id})">Edit</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openEditModal(id) {
            const product = state.products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('edit-id').value = product.id;
            document.getElementById('edit-name').value = product.name;
            document.getElementById('edit-price').value = product.price;
            document.getElementById('edit-image').value = product.image;

            document.getElementById('edit-product-modal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('edit-product-modal').style.display = 'none';
        }

        async function handleProductUpdate(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value; // String ID now
            const name = document.getElementById('edit-name').value;
            const price = parseFloat(document.getElementById('edit-price').value);
            const image = document.getElementById('edit-image').value;

            const success = await updateProduct(id, { name, price, image });
            if (success) {
                closeEditModal();
            }
        }

        // Transactions Logic
        function handleTransactionSubmit(e) {
            e.preventDefault();
            const transaction = {
                date: new Date().toISOString(),
                clientName: document.getElementById('client-name').value,
                clientContact: document.getElementById('client-contact').value,
                property: document.getElementById('property-bought').value,
                status: document.getElementById('transaction-status').value,
                receipt: 'receipt_mock.pdf', // Mock upload
                amount: 0,
                items: [],
                customer: {
                    name: document.getElementById('client-name').value,
                    email: document.getElementById('client-contact').value
                }
            };

            db.collection('orders').add(transaction)
                .then(() => {
                    alert('Transaction recorded successfully!');
                    e.target.reset();
                })
                .catch(error => alert("Error: " + error.message));
        }

        function renderTransactionsTable() {
            const tbody = document.querySelector('#transactions-table tbody');
            tbody.innerHTML = '';

            if (state.transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No transactions yet.</td></tr>';
                return;
            }

            state.transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t => {
                const tr = document.createElement('tr');
                const itemsList = t.items.map(i => `${i.name} (x${i.quantity})`).join(', ');
                tr.innerHTML = `
                    <td data-label="Date">${new Date(t.date).toLocaleDateString()}</td>
                    <td data-label="Order ID">#${t.id}</td>
                    <td data-label="Customer">
                        <strong>${t.customer.name}</strong><br>
                        <small>${t.customer.email}</small>
                    </td>
                    <td data-label="Amount">${formatPrice(t.amount)}</td>
                    <td data-label="Status">
                        <select onchange="handleStatusChange(${t.id}, this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid #ddd;">
                            <option value="Pending" ${t.status === 'Pending' ? 'selected' : ''}>Pending</option>
                            <option value="Processing" ${t.status === 'Processing' ? 'selected' : ''}>Processing</option>
                            <option value="Shipped" ${t.status === 'Shipped' ? 'selected' : ''}>Shipped</option>
                            <option value="Delivered" ${t.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            <option value="Cancelled" ${t.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td data-label="Items"><small>${itemsList}</small></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function handleStatusChange(orderId, newStatus) {
            updateOrderStatus(orderId, newStatus);
        }

        // Clients Logic
        function renderClientsTable() {
            const tbody = document.querySelector('#clients-table tbody');
            const select = document.getElementById('notif-client-select');
            tbody.innerHTML = '';
            select.innerHTML = '<option value="">-- Select Client --</option>';

            // Filter only non-admin users
            const clients = state.users.filter(u => !u.isAdmin);

            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">No clients registered yet.</td></tr>';
                return;
            }

            clients.forEach(client => {
                // Populate Table
                const tr = document.createElement('tr');
                const cartCount = client.cart ? client.cart.length : 0;
                tr.innerHTML = `
                    <td data-label="Name">${client.name}</td>
                    <td data-label="Email">${client.email}</td>
                    <td data-label="Cart">${cartCount} items <a href="#" onclick="viewClientCart('${client.email}')" style="font-size: 0.8rem; margin-left: 5px;">(View)</a></td>
                    <td data-label="Actions">
                        <button class="btn-sm btn" onclick="prepareNotification('${client.email}')">Notify</button>
                    </td>
                `;
                tbody.appendChild(tr);

                // Populate Select
                const option = document.createElement('option');
                option.value = client.email;
                option.textContent = `${client.name} (${client.email})`;
                select.appendChild(option);
            });
        }

        function viewClientCart(email) {
            const client = state.users.find(u => u.email === email);
            if (!client) return;

            const container = document.getElementById('client-cart-content');
            if (!client.cart || client.cart.length === 0) {
                container.innerHTML = '<p>Cart is empty.</p>';
            } else {
                let html = '<ul style="list-style: none; padding: 0;">';
                client.cart.forEach(item => {
                    html += `<li style="border-bottom: 1px solid #eee; padding: 10px 0;">
                        <strong>${item.name}</strong> - ${formatPrice(item.price)} x ${item.quantity}
                    </li>`;
                });
                html += '</ul>';
                container.innerHTML = html;
            }

            document.getElementById('view-cart-modal').style.display = 'flex';
        }

        function prepareNotification(email) {
            document.getElementById('notif-client-select').value = email;
            document.getElementById('notif-message').focus();
        }

        function handleSendNotification(e) {
            e.preventDefault();
            const email = document.getElementById('notif-client-select').value;
            const message = document.getElementById('notif-message').value;

            if (!email || !message) return;

            const userIndex = state.users.findIndex(u => u.email === email);
            if (userIndex !== -1) {
                if (!state.users[userIndex].notifications) {
                    state.users[userIndex].notifications = [];
                }

                state.users[userIndex].notifications.unshift({
                    id: Date.now(),
                    date: new Date().toLocaleDateString(),
                    message: message,
                    read: false
                });

                saveUsers();
                alert('Notification sent successfully!');
                e.target.reset();
            }
        }

        // Inbox Logic
        function renderInbox() {
            const container = document.getElementById('inbox-messages');
            const messages = JSON.parse(localStorage.getItem('botMessages')) || [];

            if (messages.length === 0) {
                container.innerHTML = '<p>No messages yet.</p>';
                return;
            }

            container.innerHTML = '';
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.style.cssText = `
                    background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary-color);
                `;
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong>${msg.sender}</strong>
                        <small>${msg.date}</small>
                    </div>
                    <div style="color: #666; font-size: 0.9rem; margin-bottom: 5px;">${msg.email}</div>
                    <p>${msg.message}</p>
                    <a href="mailto:${msg.email}" class="btn-sm btn" style="margin-top: 10px; display: inline-block;">Reply via Email</a>
                `;
                container.appendChild(div);
            });

            // Update badge
            const badge = document.getElementById('inbox-badge');
            if (messages.length > 0) {
                badge.textContent = messages.length;
                badge.style.display = 'inline-block';
            }
        }

        // Contact Info Logic
        function loadContactInfo() {
            document.getElementById('contact-email').value = state.contactInfo.email;
            document.getElementById('contact-phone').value = state.contactInfo.phone;
            document.getElementById('contact-whatsapp').value = state.contactInfo.whatsapp;
            document.getElementById('contact-address').value = state.contactInfo.address;
        }

        function handleContactUpdate(e) {
            e.preventDefault();
            state.contactInfo = {
                email: document.getElementById('contact-email').value,
                phone: document.getElementById('contact-phone').value,
                whatsapp: document.getElementById('contact-whatsapp').value,
                address: document.getElementById('contact-address').value
            };
            saveContactInfo();
            alert('Contact information updated! Changes will be reflected on the main site.');
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('edit-product-modal');
            const cartModal = document.getElementById('view-cart-modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
            if (event.target == cartModal) {
                cartModal.style.display = 'none';
            }
        }

        // Bot Settings Logic
        function loadBotSettings() {
            const settings = JSON.parse(localStorage.getItem('botSettings')) || { recordingEnabled: true };
            document.getElementById('bot-recording-toggle').checked = settings.recordingEnabled !== false;
            updateRecordingStatus(settings.recordingEnabled !== false);
        }

        function handleBotRecordingToggle() {
            const isEnabled = document.getElementById('bot-recording-toggle').checked;
            const settings = { recordingEnabled: isEnabled };
            localStorage.setItem('botSettings', JSON.stringify(settings));
            updateRecordingStatus(isEnabled);
            alert(isEnabled ? 'Bot data recording enabled!' : 'Bot data recording disabled. The bot will still respond but won\'t save data to your inbox.');
        }

        function updateRecordingStatus(isEnabled) {
            const statusDiv = document.getElementById('recording-status');
            if (isEnabled) {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Recording is currently <strong>ENABLED</strong>. All bot interactions will be saved to your inbox.';
            } else {
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Recording is currently <strong>DISABLED</strong>. The bot will respond to customers but won\'t save data.';
            }
        }
        // Product Management Logic
        function renderProductsTable() {
            const tbody = document.querySelector('#products-table tbody');
            tbody.innerHTML = '';

            state.products.forEach(product => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img src="${product.image}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;"></td>
                    <td>${product.name}</td>
                    <td>${formatPrice(product.price)}</td>
                    <td>${product.category}</td>
                    <td>
                        <button class="btn-sm btn" onclick="openEditProductModal(${product.id})">Edit</button>
                        <button class="btn-sm btn" style="background-color: #dc3545;" onclick="handleDeleteProduct(${product.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openAddProductModal() {
            document.getElementById('product-form').reset();
            document.getElementById('prod-id').value = '';
            document.getElementById('modal-title').textContent = 'Add Product';
            document.getElementById('product-modal').style.display = 'block';
        }

        function openEditProductModal(id) {
            const product = state.products.find(p => p.id === id);
            if (!product) return;

            document.getElementById('prod-id').value = product.id;
            document.getElementById('prod-name').value = product.name;
            document.getElementById('prod-price').value = product.price;
            document.getElementById('prod-category').value = product.category;
            document.getElementById('prod-image').value = product.image;

            document.getElementById('modal-title').textContent = 'Edit Product';
            document.getElementById('product-modal').style.display = 'block';
        }

        function handleDeleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                if (deleteProduct(id)) {
                    renderProductsTable();
                }
            }
        }

        document.getElementById('product-form').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('prod-id').value;
            const product = {
                name: document.getElementById('prod-name').value,
                price: parseFloat(document.getElementById('prod-price').value),
                category: document.getElementById('prod-category').value,
                image: document.getElementById('prod-image').value
            };

            if (id) {
                if (updateProduct(id, product)) {
                    document.getElementById('product-modal').style.display = 'none';
                    renderProductsTable();
                }
            } else {
                if (addProduct(product)) {
                    document.getElementById('product-modal').style.display = 'none';
                    renderProductsTable();
                }
            }
        };
    </script>
</body>

</html>